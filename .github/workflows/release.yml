name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install PostgreSQL dev headers (pg16)
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-16 postgresql-server-dev-16

      - name: Install cargo-pgrx (0.16.1) and init
        run: |
          cargo install --locked cargo-pgrx --version 0.16.1
          cargo pgrx init --pg16 /usr/lib/postgresql/16/bin/pg_config

      - name: Cache cargo build
        uses: Swatinem/rust-cache@v2

      - name: Generate test keys (RSA + Ed25519)
        run: |
          openssl version
          # RSA keys for RS256 tests
          openssl genrsa -out test_private.pem 2048
          openssl rsa -in test_private.pem -pubout -out test_public.pem
          # Ed25519 keys for EdDSA tests
          openssl genpkey -algorithm ed25519 -out test_ed25519_private.pem
          openssl pkey -in test_ed25519_private.pem -pubout -out test_ed25519_public.pem

      - name: Run unit tests (pg16)
        run: cargo test --no-default-features --features pg16 --verbose

      - name: Build release library (pg16)
        run: cargo build --release --features pg16 --no-default-features

      - name: Package extension files (pg16)
        run: |
          chmod +x package.sh
          PG_FEATURE=pg16 ./package.sh

      - name: Create tarball
        id: pack
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          TARBALL="pgjwt_rs-${VERSION}-pg16-linux-x86_64.tar.gz"
          tar -czf "$TARBALL" -C pkg .
          echo "tarball=$TARBALL" >> $GITHUB_OUTPUT

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.pack.outputs.tarball }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
